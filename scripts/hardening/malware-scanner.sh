#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

CLAMAV_SRC="$REPO_ROOT/scripts/sec-configs/clamav"
CLAMAV_DST="/etc/clamav/clamd.conf"


echo "[*] Ensuring ClamAV is installed..."

if ! command -v clamscan >/dev/null 2>&1; then
  sudo apt update
  sudo apt install -y clamav clamav-daemon clamav-freshclam
fi

echo "[*] Applying ClamAV configuration..."

sudo cp "$CLAMAV_SRC/clamd.conf" /etc/clamav/clamd.conf
sudo cp "$CLAMAV_SRC/freshclam.conf" /etc/clamav/freshclam.conf

sudo chown root:root /etc/clamav/clamd.conf /etc/clamav/freshclam.conf
sudo chmod 644 /etc/clamav/clamd.conf /etc/clamav/freshclam.conf

echo "[*] Updating virus database..."
sudo systemctl stop clamav-freshclam || true
sudo freshclam
sudo systemctl start clamav-freshclam

echo "[*] Restarting ClamAV daemon..."
sudo systemctl enable clamav-daemon
sudo systemctl restart clamav-daemon

echo "[*] Verifying ClamAV status..."
systemctl is-active clamav-daemon
systemctl is-active clamav-freshclam

echo "[+] Malware scanner hardening applied successfully"
